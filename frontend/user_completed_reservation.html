<!DOCTYPE html>
<head>

<!-- Basic Page Needs
================================================== -->
<title>已完成的訂單 | Peter Parker</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- CSS
================================================== -->
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/main-color.css" id="colors">
<script type="module" src="scripts/userinfo.js"></script>
<script type="module" src="scripts/get_photo.js"></script>
<link rel="icon" href="images/logo-icon.png" type="image/png">

</head>


<body>
<div id="loadingOverlay" class="overlay">
	<div class="spinner"></div>
	</div>

<!-- Wrapper -->
<div id="wrapper">

<!-- Header Container
================================================== -->
<header id="header-container" class="fixed fullwidth dashboard">

	<!-- Header -->
	<div id="header" class="not-sticky">
		<div class="container">
			
			<!-- Left Side Content -->
			<div class="left-side">
				
				<!-- Logo -->
				<div id="logo">
					<a href="index.html"><img src="images/logo.png" alt=""></a>
					<a href="index.html" class="dashboard-logo"><img src="images/logo2.png" alt=""></a>
				</div>

				<!-- Mobile Navigation -->
				<div class="mmenu-trigger">
					<button class="hamburger hamburger--collapse" type="button">
						<span class="hamburger-box">
							<span class="hamburger-inner"></span>
						</span>
					</button>
				</div>

				<!-- Main Navigation -->
				<nav id="navigation" class="style-1">
					<ul id="responsive">

						<li><a href="index.html">首頁</a>
						</li>

						<li><a>如何使用</a>
							<ul>
								<li><a href="how_to_reserve.html">如何預約車位</a></li>
								<li><a href="dashboard-messages.html">如何出租車位</a></li>
							</ul>
						</li>

						<li><a>最新消息</a>
						</li>

						<li><a href="#">聯絡我們</a></li>

						<li><a href="#">業主登入</a></li>
							
						
					</ul>
				</nav>
				<div class="clearfix"></div>
				<!-- Main Navigation / End -->
				
			</div>
			<!-- Left Side Content / End -->

			<!-- Right Side Content / End -->
			<div class="right-side">
				<!-- Header Widget -->
				<div class="header-widget">
					
					<!-- User Menu -->
					<div class="user-menu">
						<div class="user-name"><span><img id="avatar-preview" src="images/dashboard-avatar.jpg" alt=""></span><p style="display:inline "id="username2"></p></div>
						<ul>
							<li><a href="user_center.html"><i class="sl sl-icon-settings"></i>會員中心</a></li>
							<li><a href="user_profile.html"><i class="sl sl-icon-user"></i>個人資料</a></li>
							<li><a href="parking_map.html"><i class="sl sl-icon-control-play"></i>開始預約</a></li>
						</ul>
					</div>
					<a href="index.html" id="logout_btn" class="button border with-icon" onclick="localStorage.removeItem('peterParkerToken'); localStorage.removeItem('userId');"></i>會員登出</a>
					</div>
				</div>
				<!-- Header Widget / End -->
			</div>
			<!-- Right Side Content / End -->

		</div>
	</div>
	<!-- Header / End -->

</header>
<div class="clearfix"></div>
<!-- Header Container / End -->


<!-- Dashboard -->
<div id="dashboard">

	<!-- Navigation
	================================================== -->

	<!-- Responsive Navigation Trigger -->
	<a href="#" class="dashboard-responsive-nav-trigger"><i class="fa fa-reorder"></i>會員中心功能選單</a>
	
	<div class="dashboard-nav">
		<div class="dashboard-nav-inner">

			<ul>
				<li><a href="user_center.html"><i class="sl sl-icon-settings"></i>會員中心</a></li>
				<li><a href="user_profile.html"><i class="sl sl-icon-user"></i>個人資料</a></li>
				<li><a href="parking_map.html"><i class="sl sl-icon-control-play"></i>開始預約</a></li>
				<li class="active"><a><i class="sl sl-icon-layers"></i>我的訂單</a>
					<ul>
						<li><a href="user_ongoing_reservation.html">未完成訂單</a></li>
						<li><a href="user_completed_reservation.html">已完成訂單</a></li>
						<li>
					</ul>	
				</li>
				<li><a href="user_my_favourites.html"><i class="sl sl-icon-heart"></i>我的最愛</a></li>
				<li><a href="user_my_blacklist.html"><i class="sl sl-icon-ban"></i>我的黑名單</a></li>
			</ul>	

	</div>
	</div>
	<!-- Navigation / End -->


	<!-- Content
	================================================== -->
	<div class="dashboard-content">

		<!-- Titlebar -->
		<div id="titlebar">
			<div class="row">
				<div class="col-md-12 headline centered">
					<h2>已完成的訂單</h2>
				</div>
			</div>
		</div>

		<div class="row">
			
			<!-- Listings -->
			<div class="col-lg-12 col-md-12">
				<div class="dashboard-list-box margin-top-0">
					
					<!-- Booking Requests Filters  -->
					<div class="booking-requests-filter">

					</div>

					<h4>已完成的訂單</h4>
					<ul id="orderlist">
						<img src="images/no-order-found.png">
						<h4>還沒有任何訂單喔，趕快享受快速又便捷的預約服務吧！</h4>


					</ul>
				</div>
			</div>


			<!-- Copyrights -->
			<div class="col-md-12">
				<div class="copyrights">Copyright © 2024 Peter Parker | All Rights Reserved.</div>
			</div>
		</div>

	</div>
	<!-- Content / End -->


</div>
<!-- Dashboard / End -->


</div>
<!-- Wrapper / End -->


<!-- Scripts
================================================== -->
<script type="text/javascript" src="scripts/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="scripts/jquery-migrate-3.3.2.min.js"></script>
<script type="text/javascript" src="scripts/mmenu.min.js"></script>
<script type="text/javascript" src="scripts/chosen.min.js"></script>
<script type="text/javascript" src="scripts/slick.min.js"></script>
<script type="text/javascript" src="scripts/rangeslider.min.js"></script>
<script type="text/javascript" src="scripts/magnific-popup.min.js"></script>
<script type="text/javascript" src="scripts/waypoints.min.js"></script>
<script type="text/javascript" src="scripts/counterup.min.js"></script>
<script type="text/javascript" src="scripts/jquery-ui.min.js"></script>
<script type="text/javascript" src="scripts/tooltips.min.js"></script>
<script type="text/javascript" src="scripts/custom.js"></script>

<!-- Date Range Picker - docs: http://www.daterangepicker.com/ -->
<script src="scripts/moment.min.js"></script>
<script src="scripts/daterangepicker.js"></script>

<script>
$(function() {

    var start = moment().subtract(29, 'days');
    var end = moment();

    function cb(start, end) {
        $('#booking-date-range span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
    }
    cb(start, end);
    $('#booking-date-range').daterangepicker({
    	"opens": "left",
	    "autoUpdateInput": false,
	    "alwaysShowCalendars": true,
        startDate: start,
        endDate: end,
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    cb(start, end);

});

// Calendar animation and visual settings
$('#booking-date-range').on('show.daterangepicker', function(ev, picker) {
	$('.daterangepicker').addClass('calendar-visible calendar-animated bordered-style');
	$('.daterangepicker').removeClass('calendar-hidden');
});
$('#booking-date-range').on('hide.daterangepicker', function(ev, picker) {
	$('.daterangepicker').removeClass('calendar-visible');
	$('.daterangepicker').addClass('calendar-hidden');
});
</script>


<script>
document.addEventListener("DOMContentLoaded", listeditAll());


function listeditAll () {
    const userId = localStorage.getItem('userId');
    fetch(`http://localhost:8081/user/已完成/${userId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.status === 204) {
            console.log("No orders found for this user.");
            return []; // Return empty array if no content
        } else if (response.ok) {
            return response.json();
        } else {
            throw new Error('Failed to fetch user orders');
        }
    })
    .then(data => {
        if (data && data.length > 0) {
			console.log(data);
            const orderList = document.getElementById('orderlist');
            orderList.innerHTML = ""; // Clear existing orders if any
            data.forEach(order => {
                let orders = document.createElement('li');
				orders.classList.add("approved-booking");
                orders.innerHTML = `
                    <div class="list-box-listing bookings">
                        <div style="width:300px;height: 169px;border-radius:20px; overflow:hidden;">
                         <img style="object-fit: cover; height: 100%; width: 100%" src="http://localhost:8081/user/image/${order.parkingId}" alt="Parking Image"/></div>
                        <div class="list-box-listing-content">
                            <div class="inner">
                                <h3>${order.parkingName}<span class="booking-status">${order.statusId}</span></h3>
                                <div class="inner-booking-list">
                                    <h5>開始時間：</h5>
                                    <ul class="booking-list">
                                        <li class="highlighted">${order.orderStartTime}</li>
                                    </ul>
                                </div>
                                <div class="inner-booking-list">
                                    <h5>結束時間：</h5>
                                    <ul class="booking-list">
                                        <li class="highlighted">${order.orderEndTime}</li>
                                    </ul>
                                </div>    
                                <div class="inner-booking-list">
                                    <h5>總共金額：</h5>
                                    <ul class="booking-list">
                                        <li class="highlighted">$${order.orderTotalIncome}</li>
                                    </ul>
                                </div>        
                                <div class="inner-booking-list">
                                    <h5>訂單編號：</h5>
                                    <ul class="booking-list">
                                        <li>${order.orderId}</li>
                                    </ul>
                                </div>
								    <div class="inner-booking-list">
                                    <h5>車位編號：</h5>
                                    <ul class="booking-list">
                                        <li>${order.spaceId}</li>
                                    </ul>
                                </div>
                                <div class="inner-booking-list">
                                    <h5>您的評價：</h5>
                                    <ul class="booking-list">
                                        <li><h3 id="text-display-${order.orderId}">${order.userComment}</h3></li>
                                    </ul>
									<input type="text" id="text-input-${order.orderId}" style="display:none">
									<button id="comment-submit-button-${order.orderId}" style="display:none;" class="button gray" onclick="changeComment(${order.orderId})">確認更改</button>
                                </div>
								
                            </div>
                        </div>
						<div class="buttons-to-right" id="section${order.orderId}">
						<span id="addingSection${order.parkingId}">
						<a href="#" class="button gray" onclick="addFavourite(${order.parkingId})"><i class="sl sl-icon-heart"></i></a>
						<a href="#" class="button gray" onclick="addBlacklist(${order.parkingId})"><i class="sl sl-icon-ban"></i></a>
						</span>
						<a href="#" class="button gray" id="edit-btn-${order.orderId}" onclick="toggleEdit(${order.orderId})"><i class="sl sl-icon-pencil"></i> 更改評價</a>
						</div>
                    </div>`;
                orderList.appendChild(orders);
				checkFavourite(order.parkingId);
				checkBlacklist(order.parkingId);
				checkUserComment(order.orderId);
            });
        } else {
            console.log("No orders available.");
        }
    })
    .catch(error => {
        console.error("Error:", error);
    });


	function checkBlacklist(parkingId){
		const userId = localStorage.getItem('userId');
	// Correct the URL and fetch syntax
	fetch(`http://localhost:8081/user/ifBlacklistedAlready/${userId}/${parkingId}`, {
		method: 'GET',
		headers: {
			'Content-Type': 'application/json',
		}
	})
	.then(response => {
		if (response.ok) {
			return response.json(); // Parse JSON if response is successful
		} else {
			console.log("Response from checkFav (Error):", response);
			throw new Error("Failed to check favourite status.");
		}
	})
	.then(data => {
		if(data.isBlacklisted == "true" ){
			let addingSection = document.getElementById(data.BlacklistButton);
			addingSection.style.display="none";
			return;
		}
	})
	.catch(error => {
		console.error("Error:", error);
	});
	}
	

	function checkFavourite(parkingId) {
	const userId = localStorage.getItem('userId');
	// Correct the URL and fetch syntax
	fetch(`http://localhost:8081/user/ifFavouritedAlready/${userId}/${parkingId}`, {
		method: 'GET',
		headers: {
			'Content-Type': 'application/json',
		}
	})
	.then(response => {
		
		if (response.ok) {
			return response.json(); // Parse JSON if response is successful
		} else {
			console.log("Response from checkFav (Error):", response);
			throw new Error("Failed to check favourite status.");
		}
	})
	.then(data => {
		if(data.isFavourited == "true" ){
			let addingSection = document.getElementById(data.FavouriteButton);
			addingSection.style.display="none";
			return;
		}
	})
	.catch(error => {
		console.error("Error:", error);
	});
}

function checkUserComment(order) {
    const textInput = document.getElementById(`text-display-${order}`);
	console.log(textInput);
    if (!textInput) {
        console.error(`Element with ID text-display-${order} not found`);
        return;
    }
    let newComment = textInput.innerText;
    
    if (newComment === "null" || newComment === "") {
        newComment = "還未有評論喔，趕快留下你的感受吧";
		console.log(newComment);
		textInput.innerText = newComment;
		return;
    }
}


}
;




function addFavourite(parkingId) {
	const userId = localStorage.getItem('userId');
	const overlay = document.getElementById('loadingOverlay');
   	overlay.style.display = 'block';
	let jsonDataUpdate = {
		userId: userId,
		parkingId: parkingId
	}

	fetch(`http://localhost:8081/user/addFavourite`, {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify(jsonDataUpdate)
	})
			.then(response => {
				if (response.ok) {
					listeditAll();
				} else {
					console.log(response);
				}
			})
			.then(data => {
			})
			.catch(error => {
				console.error("Error:", error);
			})
			.finally(()=>{c
				
			});
}



function addBlacklist(parkingId) {
	const userId = localStorage.getItem('userId');
	const overlay = document.getElementById('loadingOverlay');
   	overlay.style.display = 'block';
	let jsonDataUpdate = {
		userId: userId,
		parkingId: parkingId

	}

	fetch(`http://localhost:8081/user/addBlacklist`, {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify(jsonDataUpdate)
	})
			.then(response => {
				if (response.ok) {
					listeditAll();
				} else {
					console.log(response);
				}
			})
			.then(data => {
			})
			.catch(error => {
				console.error("Error:", error);
			})
			.finally(()=>{c
				
			});
}

function toggleEdit(order) {
            const textDisplay = document.getElementById(`text-display-${order}`);
            const textInput = document.getElementById(`text-input-${order}`);
            const editBtn = document.getElementById(`edit-btn-${order}`);
			const commentButton = document.getElementById(`comment-submit-button-${order}`);
			const section = document.getElementById(`section${order}`);

			textInput.value = textDisplay.textContent;
            textDisplay.style.display = 'none';
			section.style.display="none";
            textInput.style.display = 'inline';
            editBtn.style.display = 'none';
			commentButton.style.display="inline";


            // if (editBtn.textContent === '開始修改') {
            //     // Switch to edit mode
            //     textInput.value = textDisplay.textContent;
            //     textDisplay.style.display = 'none';
            //     textInput.style.display = 'inline';
            //     editBtn.textContent = '確認';
            // } else {
            //     // Switch to view mode
            //     textDisplay.textContent = textInput.value;
            //     textDisplay.style.display = 'inline';
            //     textInput.style.display = 'none';
            //     editBtn.textContent = '開始修改';
            // }
        }

function changeComment(order){
	const textInput = document.getElementById(`text-input-${order}`);

	let newComment = textInput.value;

	let jsonData = {
		orderId: order,
		userComment: newComment
	}

	fetch("http://localhost:8081/user/updateUserComment",{
		method: 'POST',
		headers: {
			'Content-Type':'application/json',
		},
		body: JSON.stringify(jsonData)
	})
	.then(response=>{
		if(response.ok){
			listeditAll();
			return response.json();
		} else {
			return console.log("error");
		}
	})
	.catch(error=>{
		console.log("error");
		return;
	})

}

</script>





</body>
</html>